// Copyright 2018-2024 the oak authors. All rights reserved. MIT license.
import { createPromiseWithResolvers } from "./utils/create_promise_with_resolvers.ts";
// deno-lint-ignore no-explicit-any
export const DomResponse = globalThis.Response ?? class MockResponse {
};
const maybeUpgradeWebSocket = "Deno" in globalThis && "upgradeWebSocket" in globalThis.Deno ? Deno.upgradeWebSocket.bind(Deno) : undefined;
export function isNativeRequest(r) {
  return r instanceof NativeRequest;
}
/** An internal oak abstraction for handling a Deno native request. Most users
 * of oak do not need to worry about this abstraction. */ export class NativeRequest {
  #remoteAddr;
  // deno-lint-ignore no-explicit-any
  #reject;
  #request;
  #resolve;
  #resolved = false;
  #response;
  #upgradeWebSocket;
  constructor(request, info){
    this.#remoteAddr = info.remoteAddr;
    // this allows for the value to be explicitly undefined in the options
    this.#upgradeWebSocket = "upgradeWebSocket" in info ? info.upgradeWebSocket : maybeUpgradeWebSocket;
    this.#request = request;
    const { resolve, reject, promise } = createPromiseWithResolvers();
    this.#resolve = resolve;
    this.#reject = reject;
    this.#response = promise;
  }
  get body() {
    // when shimming with undici under Node.js, this is a
    // `ControlledAsyncIterable`
    // deno-lint-ignore no-explicit-any
    return this.#request.body;
  }
  get headers() {
    return this.#request.headers;
  }
  get method() {
    return this.#request.method;
  }
  get remoteAddr() {
    return this.#remoteAddr?.hostname;
  }
  get request() {
    return this.#request;
  }
  get response() {
    return this.#response;
  }
  get url() {
    try {
      const url = new URL(this.#request.url);
      return this.#request.url.replace(url.origin, "");
    } catch  {
    // we don't care about errors, we just want to fall back
    }
    return this.#request.url;
  }
  get rawUrl() {
    return this.#request.url;
  }
  // deno-lint-ignore no-explicit-any
  error(reason) {
    if (this.#resolved) {
      throw new Error("Request already responded to.");
    }
    this.#reject(reason);
    this.#resolved = true;
  }
  getBody() {
    return this.#request.body;
  }
  respond(response) {
    if (this.#resolved) {
      throw new Error("Request already responded to.");
    }
    this.#resolved = true;
    this.#resolve(response);
  }
  upgrade(options) {
    if (this.#resolved) {
      throw new Error("Request already responded to.");
    }
    if (!this.#upgradeWebSocket) {
      throw new TypeError("Upgrading web sockets not supported.");
    }
    const { response, socket } = this.#upgradeWebSocket(this.#request, options);
    this.#resolve(response);
    this.#resolved = true;
    return socket;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vanNyLmlvL0BvYWsvb2FrLzE2LjEuMC9odHRwX3NlcnZlcl9uYXRpdmVfcmVxdWVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDI0IHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHtcbiAgTmV0QWRkcixcbiAgU2VydmVyUmVxdWVzdCxcbiAgVXBncmFkZVdlYlNvY2tldEZuLFxuICBVcGdyYWRlV2ViU29ja2V0T3B0aW9ucyxcbn0gZnJvbSBcIi4vdHlwZXMudHNcIjtcbmltcG9ydCB7IGNyZWF0ZVByb21pc2VXaXRoUmVzb2x2ZXJzIH0gZnJvbSBcIi4vdXRpbHMvY3JlYXRlX3Byb21pc2Vfd2l0aF9yZXNvbHZlcnMudHNcIjtcblxuLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbmV4cG9ydCBjb25zdCBEb21SZXNwb25zZTogdHlwZW9mIFJlc3BvbnNlID0gKGdsb2JhbFRoaXMgYXMgYW55KS5SZXNwb25zZSA/P1xuICBjbGFzcyBNb2NrUmVzcG9uc2Uge307XG5cbmNvbnN0IG1heWJlVXBncmFkZVdlYlNvY2tldDogVXBncmFkZVdlYlNvY2tldEZuIHwgdW5kZWZpbmVkID1cbiAgXCJEZW5vXCIgaW4gZ2xvYmFsVGhpcyAmJiBcInVwZ3JhZGVXZWJTb2NrZXRcIiBpbiBnbG9iYWxUaGlzLkRlbm9cbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgID8gKERlbm8gYXMgYW55KS51cGdyYWRlV2ViU29ja2V0LmJpbmQoRGVubylcbiAgICA6IHVuZGVmaW5lZDtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzTmF0aXZlUmVxdWVzdChyOiBTZXJ2ZXJSZXF1ZXN0KTogciBpcyBOYXRpdmVSZXF1ZXN0IHtcbiAgcmV0dXJuIHIgaW5zdGFuY2VvZiBOYXRpdmVSZXF1ZXN0O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5hdGl2ZVJlcXVlc3RJbmZvIHtcbiAgcmVtb3RlQWRkcj86IE5ldEFkZHI7XG4gIHVwZ3JhZGVXZWJTb2NrZXQ/OiBVcGdyYWRlV2ViU29ja2V0Rm47XG59XG5cbi8qKiBBbiBpbnRlcm5hbCBvYWsgYWJzdHJhY3Rpb24gZm9yIGhhbmRsaW5nIGEgRGVubyBuYXRpdmUgcmVxdWVzdC4gTW9zdCB1c2Vyc1xuICogb2Ygb2FrIGRvIG5vdCBuZWVkIHRvIHdvcnJ5IGFib3V0IHRoaXMgYWJzdHJhY3Rpb24uICovXG5leHBvcnQgY2xhc3MgTmF0aXZlUmVxdWVzdCBpbXBsZW1lbnRzIFNlcnZlclJlcXVlc3Qge1xuICAjcmVtb3RlQWRkcj86IE5ldEFkZHI7XG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICNyZWplY3Q6IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7XG4gICNyZXF1ZXN0OiBSZXF1ZXN0O1xuICAjcmVzb2x2ZTogKHZhbHVlOiBSZXNwb25zZSkgPT4gdm9pZDtcbiAgI3Jlc29sdmVkID0gZmFsc2U7XG4gICNyZXNwb25zZTogUHJvbWlzZTxSZXNwb25zZT47XG4gICN1cGdyYWRlV2ViU29ja2V0PzogVXBncmFkZVdlYlNvY2tldEZuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHJlcXVlc3Q6IFJlcXVlc3QsXG4gICAgaW5mbzogTmF0aXZlUmVxdWVzdEluZm8sXG4gICkge1xuICAgIHRoaXMuI3JlbW90ZUFkZHIgPSBpbmZvLnJlbW90ZUFkZHI7XG4gICAgLy8gdGhpcyBhbGxvd3MgZm9yIHRoZSB2YWx1ZSB0byBiZSBleHBsaWNpdGx5IHVuZGVmaW5lZCBpbiB0aGUgb3B0aW9uc1xuICAgIHRoaXMuI3VwZ3JhZGVXZWJTb2NrZXQgPSBcInVwZ3JhZGVXZWJTb2NrZXRcIiBpbiBpbmZvXG4gICAgICA/IGluZm8udXBncmFkZVdlYlNvY2tldFxuICAgICAgOiBtYXliZVVwZ3JhZGVXZWJTb2NrZXQ7XG4gICAgdGhpcy4jcmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgY29uc3QgeyByZXNvbHZlLCByZWplY3QsIHByb21pc2UgfSA9IGNyZWF0ZVByb21pc2VXaXRoUmVzb2x2ZXJzPFJlc3BvbnNlPigpO1xuICAgIHRoaXMuI3Jlc29sdmUgPSByZXNvbHZlO1xuICAgIHRoaXMuI3JlamVjdCA9IHJlamVjdDtcbiAgICB0aGlzLiNyZXNwb25zZSA9IHByb21pc2U7XG4gIH1cblxuICBnZXQgYm9keSgpOiBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5PiB8IG51bGwge1xuICAgIC8vIHdoZW4gc2hpbW1pbmcgd2l0aCB1bmRpY2kgdW5kZXIgTm9kZS5qcywgdGhpcyBpcyBhXG4gICAgLy8gYENvbnRyb2xsZWRBc3luY0l0ZXJhYmxlYFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgcmV0dXJuIHRoaXMuI3JlcXVlc3QuYm9keSBhcyBhbnk7XG4gIH1cblxuICBnZXQgaGVhZGVycygpOiBIZWFkZXJzIHtcbiAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC5oZWFkZXJzO1xuICB9XG5cbiAgZ2V0IG1ldGhvZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLiNyZXF1ZXN0Lm1ldGhvZDtcbiAgfVxuXG4gIGdldCByZW1vdGVBZGRyKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuI3JlbW90ZUFkZHI/Lmhvc3RuYW1lO1xuICB9XG5cbiAgZ2V0IHJlcXVlc3QoKTogUmVxdWVzdCB7XG4gICAgcmV0dXJuIHRoaXMuI3JlcXVlc3Q7XG4gIH1cblxuICBnZXQgcmVzcG9uc2UoKTogUHJvbWlzZTxSZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLiNyZXNwb25zZTtcbiAgfVxuXG4gIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCh0aGlzLiNyZXF1ZXN0LnVybCk7XG4gICAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC51cmwucmVwbGFjZSh1cmwub3JpZ2luLCBcIlwiKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXJyb3JzLCB3ZSBqdXN0IHdhbnQgdG8gZmFsbCBiYWNrXG4gICAgfVxuICAgIHJldHVybiB0aGlzLiNyZXF1ZXN0LnVybDtcbiAgfVxuXG4gIGdldCByYXdVcmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC51cmw7XG4gIH1cblxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBlcnJvcihyZWFzb24/OiBhbnkpOiB2b2lkIHtcbiAgICBpZiAodGhpcy4jcmVzb2x2ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlcXVlc3QgYWxyZWFkeSByZXNwb25kZWQgdG8uXCIpO1xuICAgIH1cbiAgICB0aGlzLiNyZWplY3QocmVhc29uKTtcbiAgICB0aGlzLiNyZXNvbHZlZCA9IHRydWU7XG4gIH1cblxuICBnZXRCb2R5KCk6IFJlYWRhYmxlU3RyZWFtPFVpbnQ4QXJyYXk+IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuI3JlcXVlc3QuYm9keTtcbiAgfVxuXG4gIHJlc3BvbmQocmVzcG9uc2U6IFJlc3BvbnNlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuI3Jlc29sdmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSZXF1ZXN0IGFscmVhZHkgcmVzcG9uZGVkIHRvLlwiKTtcbiAgICB9XG4gICAgdGhpcy4jcmVzb2x2ZWQgPSB0cnVlO1xuICAgIHRoaXMuI3Jlc29sdmUocmVzcG9uc2UpO1xuICB9XG5cbiAgdXBncmFkZShvcHRpb25zPzogVXBncmFkZVdlYlNvY2tldE9wdGlvbnMpOiBXZWJTb2NrZXQge1xuICAgIGlmICh0aGlzLiNyZXNvbHZlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUmVxdWVzdCBhbHJlYWR5IHJlc3BvbmRlZCB0by5cIik7XG4gICAgfVxuICAgIGlmICghdGhpcy4jdXBncmFkZVdlYlNvY2tldCkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlVwZ3JhZGluZyB3ZWIgc29ja2V0cyBub3Qgc3VwcG9ydGVkLlwiKTtcbiAgICB9XG4gICAgY29uc3QgeyByZXNwb25zZSwgc29ja2V0IH0gPSB0aGlzLiN1cGdyYWRlV2ViU29ja2V0KFxuICAgICAgdGhpcy4jcmVxdWVzdCxcbiAgICAgIG9wdGlvbnMsXG4gICAgKTtcbiAgICB0aGlzLiNyZXNvbHZlKHJlc3BvbnNlKTtcbiAgICB0aGlzLiNyZXNvbHZlZCA9IHRydWU7XG4gICAgcmV0dXJuIHNvY2tldDtcbiAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHlFQUF5RTtBQVF6RSxTQUFTLDBCQUEwQixRQUFRLDJDQUEyQztBQUV0RixtQ0FBbUM7QUFDbkMsT0FBTyxNQUFNLGNBQStCLEFBQUMsV0FBbUIsUUFBUSxJQUN0RSxNQUFNO0FBQWMsRUFBRTtBQUV4QixNQUFNLHdCQUNKLFVBQVUsY0FBYyxzQkFBc0IsV0FBVyxJQUFJLEdBRXpELEFBQUMsS0FBYSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFDcEM7QUFFTixPQUFPLFNBQVMsZ0JBQWdCLENBQWdCO0VBQzlDLE9BQU8sYUFBYTtBQUN0QjtBQU9BO3VEQUN1RCxHQUN2RCxPQUFPLE1BQU07RUFDWCxDQUFDLFVBQVUsQ0FBVztFQUN0QixtQ0FBbUM7RUFDbkMsQ0FBQyxNQUFNLENBQXlCO0VBQ2hDLENBQUMsT0FBTyxDQUFVO0VBQ2xCLENBQUMsT0FBTyxDQUE0QjtFQUNwQyxDQUFDLFFBQVEsR0FBRyxNQUFNO0VBQ2xCLENBQUMsUUFBUSxDQUFvQjtFQUM3QixDQUFDLGdCQUFnQixDQUFzQjtFQUV2QyxZQUNFLE9BQWdCLEVBQ2hCLElBQXVCLENBQ3ZCO0lBQ0EsSUFBSSxDQUFDLENBQUMsVUFBVSxHQUFHLEtBQUssVUFBVTtJQUNsQyxzRUFBc0U7SUFDdEUsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEdBQUcsc0JBQXNCLE9BQzNDLEtBQUssZ0JBQWdCLEdBQ3JCO0lBQ0osSUFBSSxDQUFDLENBQUMsT0FBTyxHQUFHO0lBQ2hCLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHO0lBQ3JDLElBQUksQ0FBQyxDQUFDLE9BQU8sR0FBRztJQUNoQixJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUc7SUFDZixJQUFJLENBQUMsQ0FBQyxRQUFRLEdBQUc7RUFDbkI7RUFFQSxJQUFJLE9BQTBDO0lBQzVDLHFEQUFxRDtJQUNyRCw0QkFBNEI7SUFDNUIsbUNBQW1DO0lBQ25DLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUk7RUFDM0I7RUFFQSxJQUFJLFVBQW1CO0lBQ3JCLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU87RUFDOUI7RUFFQSxJQUFJLFNBQWlCO0lBQ25CLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU07RUFDN0I7RUFFQSxJQUFJLGFBQWlDO0lBQ25DLE9BQU8sSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFO0VBQzNCO0VBRUEsSUFBSSxVQUFtQjtJQUNyQixPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU87RUFDdEI7RUFFQSxJQUFJLFdBQThCO0lBQ2hDLE9BQU8sSUFBSSxDQUFDLENBQUMsUUFBUTtFQUN2QjtFQUVBLElBQUksTUFBYztJQUNoQixJQUFJO01BQ0YsTUFBTSxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRztNQUNyQyxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxFQUFFO0lBQy9DLEVBQUUsT0FBTTtJQUNOLHdEQUF3RDtJQUMxRDtJQUNBLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUc7RUFDMUI7RUFFQSxJQUFJLFNBQWlCO0lBQ25CLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUc7RUFDMUI7RUFFQSxtQ0FBbUM7RUFDbkMsTUFBTSxNQUFZLEVBQVE7SUFDeEIsSUFBSSxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7TUFDbEIsTUFBTSxJQUFJLE1BQU07SUFDbEI7SUFDQSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDYixJQUFJLENBQUMsQ0FBQyxRQUFRLEdBQUc7RUFDbkI7RUFFQSxVQUE2QztJQUMzQyxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJO0VBQzNCO0VBRUEsUUFBUSxRQUFrQixFQUFRO0lBQ2hDLElBQUksSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO01BQ2xCLE1BQU0sSUFBSSxNQUFNO0lBQ2xCO0lBQ0EsSUFBSSxDQUFDLENBQUMsUUFBUSxHQUFHO0lBQ2pCLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQztFQUNoQjtFQUVBLFFBQVEsT0FBaUMsRUFBYTtJQUNwRCxJQUFJLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtNQUNsQixNQUFNLElBQUksTUFBTTtJQUNsQjtJQUNBLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRTtNQUMzQixNQUFNLElBQUksVUFBVTtJQUN0QjtJQUNBLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLENBQ2pELElBQUksQ0FBQyxDQUFDLE9BQU8sRUFDYjtJQUVGLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUNkLElBQUksQ0FBQyxDQUFDLFFBQVEsR0FBRztJQUNqQixPQUFPO0VBQ1Q7QUFDRiJ9